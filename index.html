<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.8,maximum-scale=0.8, minimum-scale=0.8, shrink-to-fit=no">
    <meta name="apple-mobile-web-app-title" content="One Button Tracker">
    <meta name="application-name" content="One Button Tracker">
    <meta name="msapplication-TileColor" content="#5755d9">
    <meta name="theme-color" content="#5755d9">
    <title>One Button Tracker</title>
    <style>
	  </style>
  </head>

  <body>
    <script src="https://www.puck-js.com/puck.js"></script>
    <script src="lib/interface.js"></script>
    <button id="btnConnect">Connect</button>

    <script>
    // Code to upload to Bangle.js
    var BANGLE_CODE = `
    setWatch(function(e) {
     digitalWrite(LED2,0);
     var duration = e.time - e.lastTime;
     console.log([e.time,'-',duration].join(",")+"\n");
     recFile = require("Storage").open("button_presses.csv","a");
     recFile.write([e.time,'-',duration].join(",")+"\n");
    }, BTN, {edge:"falling", debounce:50, repeat:true});


   setWatch(function(e) {
     digitalWrite(LED2,1);
   }, BTN, {edge:"rising", debounce:50, repeat:true});\n
    `;

    // When we click the connect button...
    var connection;
    document.getElementById("btnConnect").addEventListener("click", function() {
      // disconnect if connected already
      if (connection) {
        connection.close();
        connection = undefined;
      }
      // Connect
      Puck.connect(function(c) {
        if (!c) {
          alert("Couldn't connect!");
          return;
        }
        connection = c;
        // Handle the data we get back, and call 'onLine'
        // whenever we get a line
        var buf = "";
        connection.on("data", function(d) {
          buf += d;
          var l = buf.split("\n");
          buf = l.pop();
          l.forEach(onLine);
        });
        // First, reset the Bangle
        connection.write("reset();\n", function() {
          // Wait for it to reset itself
          setTimeout(function() {
            // Now upload our code to it
            connection.write("\x03\x10if(1){"+BANGLE_CODE+"}\n",
              function() { console.log("Ready..."); });
          }, 1500);
        });
      });
    });
    </script>



  </body>
</html>
