<html>
 <head>
  <title>Puck.js One Button Tracker</title>
 </head>
 <body>
<script src="https://www.puck-js.com/puck.js"></script>
<button id="btnConnect">Connect</button>
<button id="btnDownload">Download</button>

<script>
// Code to upload to Bangle.js
var BANGLE_CODE = `
setWatch(function(e) {
  digitalWrite(LED2,0);
  var duration = e.time - e.lastTime;
  recFile = require("Storage").open("button_presses.csv","a");
  recFile.write([e.time,'-',duration].join(",")+';');
}, BTN, {edge:"falling", debounce:50, repeat:true});


setWatch(function(e) {
  digitalWrite(LED2,1);
}, BTN, {edge:"rising", debounce:50, repeat:true});\n
`;

// When we click the connect button...
document.getElementById("btnConnect").addEventListener("click", function() {
  Puck.write('reset();',function(){
    Puck.setTime();
    Puck.write(BANGLE_CODE);
    console.log('connected and installed 1button');
  });
})

function saveCSV(filename, csvData) {
  let a = document.createElement("a"),
    file = new Blob([csvData], {type: "Comma-separated value file"});
  let url = URL.createObjectURL(file);
  a.href = url;
  a.download = filename+".csv";
  document.body.appendChild(a);
  a.click();
  setTimeout(function() {
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
  }, 0);
}

function saveButtonRecord(record,name) {
  var csv = `${record.map(rec=>[rec.time, rec.free,rec.duration].join(",")).join("\n")}`;
  console.log(csv);
  saveCSV(name, csv);
};

function ButtonRecordLineToObject(l) {
  var t = l.trim().split(",");
  var o = {
    time: parseFloat(t[0]),
    free: t[1],
    duration: parseFloat(t[2]),
  };
  return o;
};

function downloadButtonPresses(callback) {
  var flength;
  var record;
  Puck.eval('require("Storage").open("button_presses.csv","r").getLength()',function(x){
    flength=x;
    Puck.eval('require("Storage").open("button_presses.csv","r").read('+flength+')',function(data){
      console.log(data);
      record = data.slice(0, -1).split(";").map(l=>ButtonRecordLineToObject(l));
      console.log(record);
      callback(record);
    })
  });
}

document.getElementById("btnDownload").addEventListener("click", function() {
  downloadButtonPresses(record => saveButtonRecord(record, `button_presses`));
});


</script>
 </body>
</html>
