<html>
 <head>
  <title>Bangle.js Accelerometer streaming</title>
 </head>
 <body>
<script src="https://www.puck-js.com/puck.js"></script>
<script src="lib/interface.js"></script>
<button id="btnConnect">Connect</button>
<button id="btnDownload">Download</button>


<p>X: <span class="bar"><span id="barX"></span></span></p>
<p>Y: <span class="bar"><span id="barY"></span></span></p>
<p>Z: <span class="bar"><span id="barZ"></span></span></p>
<script>
// Code to upload to Bangle.js
var BANGLE_CODE = `
setWatch(function(e) {
  digitalWrite(LED2,0);
  var duration = e.time - e.lastTime;
  recFile = require("Storage").open("button_presses.csv","a");
  recFile.write([e.time,'-',duration].join(",")+';');
}, BTN, {edge:"falling", debounce:50, repeat:true});


setWatch(function(e) {
  digitalWrite(LED2,1);
}, BTN, {edge:"rising", debounce:50, repeat:true});

`;

// When we click the connect button...
var connection;
document.getElementById("btnConnect").addEventListener("click", function() {
  // disconnect if connected already
  if (connection) {
    connection.close();
    connection = undefined;
  }
  // Connect
  Puck.connect(function(c) {
    if (!c) {
      alert("Couldn't connect!");
      return;
    }
    connection = c;
    // First, reset the Bangle
    connection.write("reset();\n", function() {
      // Wait for it to reset itself
      setTimeout(function() {
        // Now upload our code to it
        connection.write(BANGLE_CODE,
          function() { console.log("Ready..."); });
      }, 1500);
    });
  });
});

function saveAccelRecord(record,name) {
  var csv = `${record.map(rec=>[rec.time, rec.free,rec.duration].join(",")).join("\n")}`;
  Util.saveCSV(name, csv);
};

function AccelRecordLineToObject(l) {
  var t = l.trim().split(",");
  var o = {
    time: parseInt(t[0]),
    free: parseFloat(t[1]),
    duration: parseFloat(t[2]),
  };
  return o;
};

function downloadButtonPresses(callback) {
  Util.readStorageFile(`button_presses.csv`,data=>{
    var record = data.trim().split(";").map(l=>AccelRecordLineToObject(l));
    callback(record);
  });
}

document.getElementById("btnDownload").addEventListener("click", function() {
  downloadButtonPresses(record => saveAccelRecord(record, `button_presses`));
});

</script>
 </body>
</html>
